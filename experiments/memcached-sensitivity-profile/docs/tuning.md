<!--
 Copyright (c) 2017 Intel Corporation

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

# Tune Workloads & Environment

## [Red lining](https://www.wikiwand.com/en/Redline)

In order to produce a sensitivity profile, Swan needs to know the peak load for memcached.
From the peak load, Swan computes load points from 5% to 100% of node capacity.

If `SWAN_PEAK_LOAD` flag is set to `0`, Swan will try to find maximum capacity by it's own, but it might not always be able to return stable results.

Memcached should be able to serve roughly 100k-200k QPS per thread.

## Mutilate Tuning

Swan use mutilate as its load generator for memcached. It has previously been used in [published latency studies for memcached](http://csl.stanford.edu/~christos/publications/2014.mutilate.eurosys.pdf) and is a distributed high-performance load generator.

When running mutilate in a distributed setup, the master process (or coordinator) connects to the target memcached instance in conjunction with the load being generated by the agents. Below, the master connection is highlighted with green and the main load from the agents is highlighted with red.

![Mutilate architecture](../../../docs/mutilate.png)

In this way, the mutilate master continuously communicates the target per-agent load, gets achieved load back and performs latency readings on samples connections it establish to the memcached instance directly.

When configuring the mutilate cluster, one central aspect is the _number of concurrent connections_ to memcached.
It is recommended to aim for 100-200 connections per memcached server thread.

For mutilate, agents should establish significantly less than 100 connections per mutilate thread. Aiming for somewhere between 5-15 should be doable.
Also, the mutilate agent thread count should not exceed the number of physical cores on the machine.

The math is then as follows:

```
Total connections = number of agents x number of agent threads x agent connection count
```

For a memcached instance with 4 threads, we can aim for 800 concurrent connection:
```
4 agents x 20 threads x 10 connections = 800 concurrent connections
```

The above is configured with the following flags:
```
--mutilate_agent_threads=8    Mutilate agent threads (-T).
--mutilate_agent_port=5556    Mutilate agent port (-P).
--mutilate_agent_connections=1  
                              Mutilate agent connections (-c).
--mutilate_agent_connections_depth=1  
                              Mutilate agent connections (-d).
--mutilate_agent_affinity     Mutilate agent affinity (--affinity).
--mutilate_agent_blocking     Mutilate agent blocking (--blocking -B).
--mutilate_master_threads=8   Mutilate master threads (-T).
--mutilate_master_connections=4  
                              Mutilate master connections (-C).
--mutilate_master_connections_depth=4  
                              Mutilate master connections depth (-C).
--mutilate_master_affinity    Mutilate master affinity (--affinity).
--mutilate_master_blocking    Mutilate master blocking (--blocking -B).
--mutilate_master_qps=1000    Mutilate master QPS value (-Q).
```

In essence, it is unfortunately very easy to see high latency measurements due to unintended interference and client side queuing in mutilate.
On top of the recommendations, we have found that reducing the number agent threads and connections and increasing the measurement time to around 30 seconds with the `--load_duration` flag helps.
To accommodate for the fewer connections per agent, you can safely add more agents.

Another option to increase precision of the latency measurements, mutilate gives the option to use blocking vs non-blocking IO. Enabling this increases the precision but also increases the CPU load on the mutilate agents.

## Memcached Tuning

One of the most important configuration options for memcached is the thread count. We recommend _half physical core count per socket_. In a machine with 32 hyper threads over 16 cores and 2 sockets, this equals 4 memcached threads.
This is set with the `--memcached_threads` flag or through the `SWAN_MEMCACHED_THREADS` environment variable.
The rationale for this number is explained in the [Core Isolation](theory.md#CPU-Cores-Isolation) section.
Lastly, the maximum number of connections to memcached can be set with the `--memcached_connections` flag or through the `SWAN_MEMCACHED_CONNECTIONS` environment variable.

## Next
You are ready to go!

For further debugging, please see [Troubleshooting](troubleshooting.md) page.

